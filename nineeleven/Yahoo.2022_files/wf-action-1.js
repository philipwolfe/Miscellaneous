!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wafer-action",[],e):"object"==typeof exports?exports["wafer-action"]=e():(t.wafer=t.wafer||{},t.wafer.wafers=t.wafer.wafers||{},t.wafer.wafers["wafer-action"]=e())}("undefined"!=typeof self?self:this,function(){return function(t){function e(o){if(r[o])return r[o].exports;var a=r[o]={i:o,l:!1,exports:{}};return t[o].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var r={};return e.m=t,e.c=r,e.d=function(t,r,o){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="https://s.yimg.com/aaq/wf/",e(e.s="./src/entry.js")}({"./src/entry.js":function(t,e,r){"use strict";function o(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},p=function(){function t(t,e){var r=[],o=!0,a=!1,n=void 0;try{for(var i,s=t[Symbol.iterator]();!(o=(i=s.next()).done)&&(r.push(i.value),!e||r.length!==e);o=!0);}catch(t){a=!0,n=t}finally{try{!o&&s.return&&s.return()}finally{if(a)throw n}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),d=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}(),f=[],b=window.wafer,v=b.constants,y=b.features,m=b.utils,h=b.WaferBaseClass,g=v.ATTR_PREFIX,w=m.fetchWithCache,k=m.findAncestor,_=m.getWaferInstanceForElem,S=["handleClick"],P="wafer-action-is-true",T={block:-1,unblock:0},A="publisher",E={},O=function(t){function e(t){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=i.appId,c=i.actionHost,u=i.bookmarkActionHost,d=i.crumb,b=i.id,v=i.name,y=i.providerBrandProperty,m=i.selector,h=i.shouldSaveToStorage,w=i.subType,_=i.type;a(this,e);var T=n(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,{selector:m},{STATE_ATTRS:f}));s=t.getAttribute(g+"app-id")||s,d=t.getAttribute(g+"crumb")||d;var E=t.getAttribute(g+"action-type")||_||"follow",O=t.getAttribute(g+"action-api-path"),I=t.getAttribute(g+"action-sub-type")||w,j=t.getAttribute(g+"action-sub-type-category")||"",L=t.getAttribute(g+"action-id")||b,B=t.getAttribute(g+"action-content-id")||"",C=t.getAttribute(g+"action-label"),H=t.getAttribute(g+"action-name")||v,x=C&&C.split("|")||[],D=p(x,2),R=D[0],W=D[1],F=t.getAttribute(g+"action-title")||"",M=t.getAttribute(g+"action-boundary"),N={follow:c+"api/v3/topics?appId="+s,block:c+"api/v1/content/feedback/"+(I===A?A:"entities")+"?appId="+s,blockProvider:c+"api/v1/providerbrands/block/providers/"+L+"?appId="+s,unblockProviderBrand:c+"api/v1/providerbrands/block?appId="+s},J=O||N[E],K=M&&k(t,M);return T._util=l({},T._util,(r={actionHost:c,apiPath:J,appId:s,bookmarkActionHost:u,boundaryElem:K,subType:I,contentId:B,crumb:d,elem:t,falseLabel:W,id:L,mappingId:L+E+I+j,providerBrandProperty:y,subTypeCategory:j,shouldSaveToStorage:void 0===h?void 0:!!h,name:H},o(r,"subType",I),o(r,"title",F),o(r,"trueLabel",R),o(r,"type",E),r)),S.forEach(function(t){T[t]=T[t].bind(T)}),T._state={actionStatus:!1,inProgress:!1},t.classList.add("has-click","has-wafer-click"),setTimeout(function(){T.setActionStatus(t.classList.contains(P))},0),T}return i(e,t),d(e,[{key:"statusDidUpdate",value:function(t){var e=this._util.elem;if(e){var r=this._util,o=r.falseLabel,a=r.trueLabel;this._state.actionStatus=t,t?(o&&e.setAttribute("title",o),e.classList.add(P)):(a&&e.setAttribute("title",a),e.classList.remove(P))}}},{key:"saveToStorage",value:function(){if(y.localStorage){var t=this._util,r=t.id,o=t.name,a=void 0===o?"":o,n=t.subType,i=t.type,s=Date.now()+9e5;return window.localStorage.setItem(e.LS_KEY,JSON.stringify({id:r,name:a,subType:n,ttl:s,type:i})),Promise.resolve()}}},{key:"triggerTopicAction",value:function(t){var e=this._util,r=e.appId,a=e.actionHost,n=e.bookmarkActionHost,i=e.contentId,s=e.id,c=e.name,u=e.providerBrandProperty,l=e.shouldSaveToStorage,p=e.subType,d=e.subTypeCategory,f=e.title,b=e.type,v=this._util.apiPath,y={follow:this._state.actionStatus?"PUT":"DELETE",block:"POST",blockProvider:this._state.actionStatus?"PUT":"DELETE",bookmark:this._state.actionStatus?"POST":"DELETE",urlBookmark:"DELETE",unblockProviderBrand:"POST"},m=y[b],h=void 0,g=void 0;return"follow"===b?(h={types:o({},p,[{id:s}])},g={Crumb:t},"provider"===p&&(h.types[p][0].type=d||"PROVIDER")):"block"===b?(h={entities:[{entity_id:s,entity_type:p,score:T[this._state.actionStatus?"block":"unblock"]}]},g={Crumb:t},p===A&&(h.entities[0].entity_name=c)):"blockProvider"===b?(h={property:u},g={Crumb:t}):"unblockProviderBrand"===b?(h={brands:[{id:s}]},g={Crumb:t}):"bookmark"===b?("DELETE"===m?v=n+"api/v1/user/bookmarks/"+p+"/"+i+"?appId="+r:(v=n+"api/v1/user/bookmarks/"+p+"?appId="+r,h={contentId:i,title:f}),g={"X-CSRF-Token":t}):"urlBookmark"===b?(v="deleteFolder"===p?a+"api/v1/bookmarks/folders/"+i+"?appId="+r:a+"api/v1/bookmarks/items/"+i+"?appId="+r,g={Crumb:t}):"location"===b&&(h={requests:{g0:{resource:"WeatherLocationService.favoriteLocation",operation:this._state.actionStatus?"create":"delete",params:{woeid:s}}}}),l?this.saveToStorage():w(v,{body:JSON.stringify(h),cache:0,clientHeaders:g,credentials:"include",method:m,mode:"cors"})}},{key:"getCrumb",value:function(){var t=this._util,e=t.appId,r=t.actionHost,o=t.bookmarkActionHost,a=t.shouldSaveToStorage,n=t.type;if("location"===n)return Promise.resolve({});var i=this._util.crumb||E[n];if(i||a)return new Promise(function(t){t(i||"")});var s=void 0;return s="bookmark"===n?o+"api/v1/auth/crumb?appId="+e:r+"api/v1/auth/crumb?appId="+e,w(s,{cache:0,credentials:"include",mode:"cors"}).then(function(t){var e=t.crumb;if(E[n]=e,!e)throw new Error("crumb not found");return e})}},{key:"trigger",value:function(t){var e=this,r=this._util.type;if(t){var o=t.crumb;o&&(E[r]=o),this._util=l({},this._util,t)}var a=this._util,n=a.elem,i=a.boundaryElem,s=a.name,c=this._state.actionStatus,u="wafer-action-in-progress-for-"+(s||r),p="wafer-action-boundary-success-for-"+(s||r),d="wafer-action-boundary-error-for-"+(s||r);this._state.inProgress=!0,i&&i.classList.add("wafer-action-in-progress",u),c?this.setActionStatus(!1):this.setActionStatus(!0),this.getCrumb().then(function(t){return e._state.inProgress=!1,e.triggerTopicAction(t)}).then(function(t){var r=t||{},o=r.result,a=void 0===o?{}:o,c=a.success,f=void 0===c?{}:c,b=f.entities,v=void 0===b?[]:b,y=e._util,m=y.id,h=y.subType,w=y.type,k={id:m,name:s,subType:h,type:w};if("blockProvider"===w||"unblockProviderBrand"===w){var S=t.data;S=void 0===S?{}:S;var P=S.currentBlocked;void 0!==P&&(k=l({currentBlocked:P},k))}var T="follow"===w&&v.some(function(t){return t.id===m}),A=("block"===w||"blockProvider"===w||"unblockProviderBrand"===w)&&(null!==t&&t===Object(t)),E="bookmark"===w&&(null!==t&&t===Object(t)),O="urlBookmark"===w&&(null!==t&&t===Object(t)),I=void 0;if("follow"===w)I=T;else if("block"===w||"blockProvider"===w||"unblockProviderBrand"===w)I=A;else if("urlBookmark"===w)I=O;else if("location"===w){var j=e._util.locationAssistTargetElem;if(!j){var L=n.getAttribute(g+"action-location-assist-target");L&&(j=e._util.locationAssistTargetElem=document.querySelector(L))}if(j){var B=_(j,"wafer-autocomplete");B&&B.instance._instance.fetchAndRenderSavedLocations()}I=!0}else I=E;if(!I)throw i&&(i.classList.add("wafer-action-boundary-error",d),i.classList.remove("wafer-action-boundary-success",p,"wafer-action-in-progress",u)),new Error("action failed");i&&(i.classList.add("wafer-action-boundary-success",p),i.classList.remove("wafer-action-boundary-error",d,"wafer-action-in-progress",u)),e.didComplete(null,k)}).catch(function(){e._state.inProgress=!1,i&&(i.classList.remove("wafer-action-in-progress",u,"wafer-action-boundary-success",p),i.classList.add("wafer-action-boundary-error",d)),e._state.actionStatus=!e._state.actionStatus,e.setActionStatus(e._state.actionStatus)})}},{key:"handleClick",value:function(t){t.preventDefault(),this._state.inProgress||this.trigger()}}]),e}(h);O.events={click:[["has-click","handleClick"]]},O.LS_KEY=g+"action-storage";var I=O,j=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},L=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}(),B=window.wafer,C=B.controllers,H=B.features,x=B.utils,D=C.WaferBaseController,R=x.getConfigFromJSONScriptNode,W=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.root,o=void 0===r?document:r,a=t.selector;s(this,e);var n=R(document.getElementById("wafer-action-config")),i=n.actionHost,u=n.appId,l=n.bookmarkActionHost,p=n.crumb,d=n.providerBrandProperty,f=n.shouldSaveToStorage,b=c(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{root:o,selector:a,props:{actionHost:i,appId:u,bookmarkActionHost:l,crumb:p,providerBrandProperty:d,shouldSaveToStorage:f,selector:a},WaferClass:I})),v=b;return b.sync(),b._state=j({},b._state,{idInstanceMapping:new Map}),I.prototype.setActionStatus=function(t){var e=this._util.mappingId,r=v._state.idInstanceMapping;r.has(e)||r.set(e,[]),r.get(e).push(this),r.get(e).forEach(function(e){e.statusDidUpdate(t)})},H.localStorage&&setTimeout(function(){b.processStoredAction(n,a)},1),b}return u(e,t),L(e,[{key:"processStoredAction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t.shouldProcessState){var r=t.actionHost,o=t.appId,a=t.bookmarkActionHost,n=t.crumb,i=t.providerBrandProperty,s=window.localStorage.getItem(I.LS_KEY);if(s){var c=document.createElement("div"),u={actionHost:r,appId:o,bookmarkActionHost:a,crumb:n,providerBrandProperty:i,selector:e};try{var l=JSON.parse(s),p=l.id,d=l.name,f=l.ttl,b=void 0===f?0:f,v=l.subType,y=l.type;b&&b>=Date.now()&&y&&v&&p&&(c.setAttribute("data-wf-on","complete:setState:wfAction.entity."+y),new I(c,Object.assign({},u,{id:p,name:d,subType:v,type:y})).trigger(j({},u,{id:p,name:d,subType:v,type:y})))}catch(t){}window.localStorage.removeItem(I.LS_KEY)}}}}]),e}(D),F=W;e.default=new F({selector:".wafer-action"})}})});