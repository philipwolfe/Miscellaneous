!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wafer-action",[],e):"object"==typeof exports?exports["wafer-action"]=e():(t.wafer=t.wafer||{},t.wafer.wafers=t.wafer.wafers||{},t.wafer.wafers["wafer-action"]=e())}("undefined"!=typeof self?self:this,function(){return function(t){function e(r){if(o[r])return o[r].exports;var n=o[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var o={};return e.m=t,e.c=o,e.d=function(t,o,r){e.o(t,o)||Object.defineProperty(t,o,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var o=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(o,"a",o),o},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="https://s.yimg.com/aaq/wf/",e(e.s="./src/entry.js")}({"./src/base.js":function(t,e,o){"use strict";function r(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},c=function(){function t(t,e){var o=[],r=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(o.push(a.value),!e||o.length!==e);r=!0);}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return o}return function(e,o){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,o);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),f=[],p=window.wafer,d=p.constants,b=p.features,y=p.utils,h=p.WaferBaseClass,v=y.fetchWithCache,m=d.ATTR_PREFIX,g=["handleClick"],w="wafer-action-is-true",_={block:-1,unblock:0},S=void 0,O="publisher",T=function(t){function e(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=o.appId,a=o.actionHost,s=o.crumb,l=o.id,p=o.name,d=o.selector,b=o.shouldSaveToStorage,y=o.subType,h=o.type;n(this,e);var v=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,{selector:d},{STATE_ATTRS:f}));r=t.getAttribute(m+"app-id")||r,s=t.getAttribute(m+"crumb")||s;var _=t.getAttribute(m+"action-type")||h||"follow",S=t.getAttribute(m+"action-sub-type")||y,T=t.getAttribute(m+"action-id")||l,j=t.getAttribute(m+"action-label"),P=t.getAttribute(m+"action-name")||p,A=j&&j.split("|")||[],k=c(A,2),E=k[0],I=k[1],x={follow:a+"api/v3/topics?appId="+r,block:a+"api/v1/content/feedback/"+(S===O?O:"entities")+"?appId="+r},C=x[_];return v._util=u({},v._util,{actionHost:a,apiPath:C,appId:r,crumb:s,elem:t,falseLabel:I,id:T,mappingId:T+_+S,shouldSaveToStorage:void 0===b?void 0:!!b,name:P,subType:S,trueLabel:E,type:_}),g.forEach(function(t){v[t]=v[t].bind(v)}),v._state={actionStatus:!1,inProgress:!1},t.classList.add("has-click"),setTimeout(function(){v.setActionStatus(t.classList.contains(w))},0),v}return a(e,t),l(e,[{key:"statusDidUpdate",value:function(t){var e=this._util.elem;if(e){var o=this._util,r=o.falseLabel,n=o.trueLabel;this._state.actionStatus=t,t?(r&&e.setAttribute("title",r),e.classList.add(w)):(n&&e.setAttribute("title",n),e.classList.remove(w))}}},{key:"saveToStorage",value:function(){if(b.localStorage){var t=this._util,o=t.id,r=t.name,n=void 0===r?"":r,i=t.subType,a=t.type,s=Date.now()+9e5;return window.localStorage.setItem(e.LS_KEY,JSON.stringify({id:o,name:n,subType:i,ttl:s,type:a})),Promise.resolve()}}},{key:"triggerTopicAction",value:function(t){var e=this._util,o=e.apiPath,n=e.id,i=e.name,a=e.shouldSaveToStorage,s=e.subType,u=e.type,c={follow:this._state.actionStatus?"PUT":"DELETE",block:"POST"},l=c[u],f=void 0;return"follow"===u&&(f={types:r({},s,[{id:n}])}),"block"===u&&(f={entities:[{entity_id:n,entity_type:s,score:_[this._state.actionStatus?"block":"unblock"]}]},s===O&&(f.entities[0].entity_name=i)),a?this.saveToStorage():v(o,{cache:0,clientHeaders:{Crumb:t},credentials:"include",method:l,body:JSON.stringify(f)})}},{key:"getCrumb",value:function(){var t=this._util.shouldSaveToStorage,e=this._util.crumb||S;if(e||t)return new Promise(function(t){t(e||"")});var o=this._util,r=o.appId,n=o.actionHost;return v(n+"api/v1/auth/crumb?appId="+r,{cache:0,credentials:"include"}).then(function(t){if(!(S=t.crumb))throw new Error("crumb not found");return S})}},{key:"trigger",value:function(t){var e=this;if(t){var o=t.crumb;o&&(S=o),this._util=u({},this._util,t)}var r=this._util.name,n=this._state.actionStatus;this._state.inProgress=!0,n?this.setActionStatus(!1):this.setActionStatus(!0),this.getCrumb().then(function(t){return e._state.inProgress=!1,e.triggerTopicAction(t)}).then(function(t){var o=t||{},n=o.result,i=void 0===n?{}:n,a=i.success,u=void 0===a?{}:a,c=u.entities,l=void 0===c?[]:c,f=e._util,p=f.id,d=f.subType,b=f.type,y="follow"===b&&l.some(function(t){return t.id===p}),h=null!==t&&"object"===(void 0===t?"undefined":s(t));if(!("follow"===b?y:h))throw new Error("action failed");e.didComplete(null,{id:p,name:r,subType:d,type:b})}).catch(function(t){e._state.inProgress=!1,e._state.actionStatus=!e._state.actionStatus,e.setActionStatus(e._state.actionStatus)})}},{key:"handleClick",value:function(t){t.preventDefault(),this._state.inProgress||this.trigger()}}]),e}(h);T.events={click:[["has-click","handleClick"]]},T.LS_KEY=m+"action-storage",e.default=T,t.exports=e.default},"./src/controller.js":function(t,e,o){"use strict";function r(){return u=n(o("./src/base.js"))}function n(t){return t&&t.__esModule?t:{default:t}}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var u,c=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},l=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),f=window.wafer,p=f.controllers,d=f.features,b=f.utils,y=p.WaferBaseController,h=b.getConfigFromJSONScriptNode,v=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.root,n=void 0===o?document:o,s=t.selector;i(this,e);var l=h(document.getElementById("wafer-action-config")),f=l.actionHost,p=l.appId,b=l.crumb,y=l.shouldSaveToStorage,v=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{root:n,selector:s,props:{actionHost:f,appId:p,crumb:b,shouldSaveToStorage:y,selector:s},WaferClass:(u||r()).default})),m=v;return v.sync(),v._state=c({},v._state,{idInstanceMapping:new Map}),(u||r()).default.prototype.setActionStatus=function(t){var e=this._util.mappingId,o=m._state.idInstanceMapping;o.has(e)||o.set(e,[]),o.get(e).push(this),o.get(e).forEach(function(e){e.statusDidUpdate(t)})},d.localStorage&&setTimeout(function(){v.processStoredAction(l,s)},1),v}return s(e,t),l(e,[{key:"processStoredAction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t.shouldProcessState){var o=t.actionHost,n=t.appId,i=t.crumb,a=window.localStorage.getItem((u||r()).default.LS_KEY);if(a){var s=document.createElement("div"),l={actionHost:o,appId:n,crumb:i,selector:e};try{var f=JSON.parse(a),p=f.id,d=f.name,b=f.ttl,y=void 0===b?0:b,h=f.subType,v=f.type;y&&y>=Date.now()&&v&&h&&p&&(s.setAttribute("data-wf-on","complete:setState:wfAction.entity."+v),new((u||r()).default)(s,Object.assign({},l,{id:p,name:d,subType:h,type:v})).trigger(c({},l,{id:p,name:d,subType:h,type:v})))}catch(t){}window.localStorage.removeItem((u||r()).default.LS_KEY)}}}}]),e}(y);e.default=v,t.exports=e.default},"./src/entry.js":function(t,e,o){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var n;e.default=new((n||function(){return n=r(o("./src/controller.js"))}()).default)({selector:".wafer-action"}),t.exports=e.default}})});